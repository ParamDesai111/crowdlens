name: db-migrate
on:
  workflow_dispatch:

jobs:
  migrate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Create DB if missing and apply schema
        uses: docker://postgres:16
        env:
          POSTGRES_URL: ${{ secrets.POSTGRES_URL }}   # points to crowdlens with sslmode=require
        with:
          args: >
            bash -lc "
              set -euo pipefail
              # derive a URL that points to the 'postgres' database
              URL_POSTGRES=\"${POSTGRES_URL/crowdlens?/postgres?}\"

              # create db if not exists
              EXISTS=$(psql \"$URL_POSTGRES\" -tAc \"SELECT 1 FROM pg_database WHERE datname='crowdlens'\")
              if [ \"$EXISTS\" != \"1\" ]; then
                psql \"$URL_POSTGRES\" -c \"CREATE DATABASE crowdlens OWNER pgadmin\"
              fi

              # apply schema to crowdlens
              psql \"$POSTGRES_URL\" -v ON_ERROR_STOP=1 -f ml_worker/sql/001_init.sql
              echo 'Schema applied'
            "
